---

- hosts: clients0[0]
  become: True
  tasks:

    - name: setup mon convenience functions
      set_fact:
        ceph: "docker exec cephfs"

    - name: delete some directories
      command: "{{ ceph }} rm -r /cephfs/seqdir/"
      ignore_errors: True

    - name: make some directories
      command: "{{ ceph }} mkdir -p /cephfs/seqdir/seqdir/dir0 /cephfs/seqdir/seqdir/dir1"
      ignore_errors: True

- hosts: clients0
  become: True
  tasks:
    - pause: minutes=5
    - name: remove old clients
      shell: "docker rm -f zlog-seq"
      ignore_errors: True

    - name: start a client in the background
      shell: >
             docker run -d \
               --name=zlog-seq \
               --entrypoint=seq-client \
               -v /etc/ceph:/etc/ceph \
               {{ ceph_client_docker_username }}/{{ ceph_client_docker_imagename }} \
               --runtime 240 --filename dir1/blah1 --op fstat

- hosts: clients1
  become: True
  tasks:
    - name: remove old clients
      shell: docker rm -f zlog-seq
      ignore_errors: True

    - name: start a client in the foreground
      shell: >
             docker run \
               --name=zlog-seq \
               --entrypoint=seq-client \
               -v /etc/ceph:/etc/ceph \
               {{ ceph_client_docker_username }}/{{ ceph_client_docker_imagename }} \
               --runtime 240 --filename dir0/blah0 --op fstat
      register: results

    - debug: var=results.stdout_lines

    - name: parse results
      connection: local
      template: src=parse.j2 dest="{{ playbook_dir|dirname }}/results/{{ site }}-{{ ansible_hostname }}-throughput.csv"
      with_items: 
        - "{{ results.stdout_lines }}"

- hosts: clients0
  become: True
  tasks:
  - name: collect the throughput from the background sequencer
    shell: docker logs zlog-seq 
    register: results
  - debug: var=results.stdout_lines
  - name: parse results
    connection: local
    template: src=parse.j2 dest="{{ playbook_dir|dirname }}/results/{{ site }}-background-{{ ansible_hostname }}-throughput.csv"
    with_items: 
      - "{{ results.stdout_lines }}"
